# 奇门遁甲排盘系统

基于 Next.js 15 + TypeScript 的专业奇门遁甲排盘系统，遵循茅山派转盘排法，提供完整的时家奇门排盘功能。

## 项目特点

- **专业排盘算法**：完整实现茅山派奇门遁甲转盘排法
- **现代化技术栈**：Next.js 15 + TypeScript + Tailwind CSS
- **完整类型安全**：全面的 TypeScript 类型定义
- **RESTful API**：支持实时排盘和自定义时间排盘
- **响应式界面**：适配多种设备的九宫格盘面展示

## 技术栈

| 类型 | 技术 | 版本 |
|------|------|------|
| 框架 | Next.js | 15.x |
| 语言 | TypeScript | 5.x |
| 样式 | Tailwind CSS | 3.x |
| UI 组件 | shadcn/ui | latest |
| 历法库 | lunar-javascript | 1.2.x |
| 包管理 | pnpm | latest |

## 快速开始

### 安装依赖

```bash
pnpm install
```

### 开发运行

```bash
pnpm dev
```

访问 `http://localhost:3000`

### 生产构建

```bash
pnpm build
pnpm start
```

## 项目结构

```
src/
├── app/                          # Next.js App Router
│   ├── api/qimen/               # 排盘 API 路由
│   │   └── route.ts             # API 处理逻辑
│   ├── page.tsx                 # 主页面
│   ├── layout.tsx               # 根布局
│   └── globals.css              # 全局样式
│
├── components/qimen/            # 奇门遁甲 UI 组件
│   ├── QimenBoard.tsx           # 九宫格盘面组件
│   ├── GongCell.tsx             # 宫位单元格组件
│   ├── BasicInfo.tsx            # 基本信息展示
│   ├── AnalysisPanel.tsx        # 综合分析面板
│   ├── GongDetails.tsx          # 九宫详解组件
│   └── CustomPanelForm.tsx      # 自定义排盘表单
│
└── lib/                         # 核心算法库
    ├── qimen.ts                 # 主计算入口（1000+ 行）
    ├── dipan.ts                 # 地盘干计算模块
    ├── jiuxing.ts               # 九星分布计算模块
    ├── bamen.ts                 # 八门分布计算模块
    ├── bashen.ts                # 八神分布计算模块
    ├── constants.ts             # 常量定义
    ├── types.ts                 # TypeScript 类型定义
    ├── utils.ts                 # 工具函数
    └── lunar-javascript.d.ts    # 历法库类型声明
```

## 核心算法

奇门遁甲排盘系统实现了完整的时家奇门转盘排法，以下是核心算法说明：

### 1. 阴阳遁与局数计算

**阴阳遁判断**：
- 冬至 → 夏至：阳遁
- 夏至 → 冬至：阴遁

**局数计算**：
- 根据当前节气确定基础局数
- 根据日干支地支确定上中下元：
  - 子、午、卯、酉 → 上元
  - 寅、申、巳、亥 → 中元
  - 辰、戌、丑、未 → 下元
- 节气 + 元 = 最终局数（1-9局）

```
局数 = 节气局数表[当前节气][元]
```

### 2. 地盘干排布

三奇六仪按固定顺序：**戊、己、庚、辛、壬、癸、丁、丙、乙**

| 遁法 | 排布规则 |
|------|----------|
| 阳遁 | 戊从局数宫开始，按洛书顺序**顺排** |
| 阴遁 | 戊从局数宫开始，按九宫数字**逆排** |

**洛书飞宫顺序**：1 → 8 → 3 → 4 → 9 → 2 → 7 → 6

```typescript
// 示例：阳遁1局
// 戊(1宫) → 己(8宫) → 庚(3宫) → 辛(4宫) → 壬(9宫) → 癸(2宫) → 丁(7宫) → 丙(6宫) → 乙(5宫)
```

### 3. 天盘干转动（转盘排法）

1. **确定值符宫**：找旬首六仪在地盘的位置
2. **确定时干落宫**：找时干在地盘的位置
3. **整体转动**：天盘从值符宫整体转动到时干落宫

**旬首与六仪对应关系**：

| 旬首 | 六仪 |
|------|------|
| 甲子旬 | 戊 |
| 甲戌旬 | 己 |
| 甲申旬 | 庚 |
| 甲午旬 | 辛 |
| 甲辰旬 | 壬 |
| 甲寅旬 | 癸 |

### 4. 九星分布

**九星原位分布**：

| 宫位 | 九星 | 别名 | 五行 |
|------|------|------|------|
| 1宫(坎) | 天蓬 | 贪狼 | 水 |
| 2宫(坤) | 天芮 | 武曲 | 土 |
| 3宫(震) | 天冲 | 禄存 | 木 |
| 4宫(巽) | 天辅 | 文曲 | 木 |
| 5宫(中) | 天禽 | 天禽 | 土 |
| 6宫(乾) | 天心 | 廉贞 | 金 |
| 7宫(兑) | 天柱 | 破军 | 金 |
| 8宫(艮) | 天任 | 巨门 | 土 |
| 9宫(离) | 天英 | 左辅 | 火 |

**排布规则**：
- 值符星 = 值符宫原位的九星
- 九星整体跟随天盘转动
- 天禽寄坤二宫

### 5. 八门分布

**八门原位分布**：

| 宫位 | 八门 | 吉凶 | 五行 |
|------|------|------|------|
| 1宫(坎) | 休门 | 吉 | 水 |
| 2宫(坤) | 死门 | 凶 | 土 |
| 3宫(震) | 伤门 | 凶 | 木 |
| 4宫(巽) | 杜门 | 凶 | 土 |
| 6宫(乾) | 开门 | 吉 | 金 |
| 7宫(兑) | 惊门 | 凶 | 金 |
| 8宫(艮) | 生门 | 吉 | 木 |
| 9宫(离) | 景门 | 吉 | 火 |

**排布规则**：
- 值使门 = 值符宫原位的八门
- 八门整体转动，转动步数 = 九星步数 × 2
- 阳遁顺时针转动，阴遁逆时针转动

### 6. 八神分布

**八神顺序**：值符、腾蛇、太阴、六合、白虎、玄武、九地、九天

| 八神 | 吉凶 | 特征 |
|------|------|------|
| 值符 | 吉 | 贵人、福星 |
| 腾蛇 | 凶 | 口舌是非 |
| 太阴 | 吉 | 柔和、隐藏 |
| 六合 | 吉 | 和谐、合作 |
| 白虎 | 凶 | 凶猛、灾祸 |
| 玄武 | 凶 | 隐秘、欺诈 |
| 九地 | 吉 | 地利、稳固 |
| 九天 | 吉 | 高升、成功 |

**排布规则**：
- 值符神从值符落宫开始
- 阳遁顺时针排布，阴遁逆时针排布

### 7. 其他计算

**空亡计算**：根据旬空确定空亡地支和对应宫位

**驿马星**：
- 寅午戌 → 马在申
- 申子辰 → 马在寅
- 巳酉丑 → 马在亥
- 亥卯未 → 马在巳

**暗干计算**：从生门原位(8宫)开始，按阴阳遁顺逆排布三奇六仪

## API 接口

### 实时排盘

```bash
GET /api/qimen
```

使用当前时间进行排盘。

### 自定义排盘

```bash
GET /api/qimen?date=2024-12-09&time=14:30:00&method=时家&purpose=综合
```

**请求参数**：

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `date` | string | 当前日期 | 日期格式：YYYY-MM-DD |
| `time` | string | 当前时间 | 时间格式：HH:MM:SS |
| `type` | string | 四柱 | 排盘类型：四柱/三元 |
| `method` | string | 时家 | 排盘方法：时家/日家/月家/年家 |
| `purpose` | string | 综合 | 用途：事业/财运/婚姻/健康/学业/综合 |

**响应示例**：

```json
{
  "basicInfo": {
    "date": "2024-12-09 14:30:00",
    "lunarDate": "二〇二四年十一月初九 14:30",
    "type": "四柱",
    "method": "时家",
    "purpose": "综合"
  },
  "siZhu": {
    "year": "甲辰",
    "month": "丙子",
    "day": "辛巳",
    "time": "乙未"
  },
  "juShu": {
    "type": "yin",
    "num": 9,
    "fullName": "阴遁9局 (上元)"
  },
  "diPanGan": { "1": "辛", "2": "庚", ... },
  "tianPanGan": { "1": "癸", "2": "壬", ... },
  "jiuXing": { "1": "天柱", "2": "天心", ... },
  "baMen": { "1": "开门", "2": "惊门", ... },
  "baShen": { "1": "九地", "2": "值符", ... },
  "jiuGongAnalysis": { ... },
  "overallAnalysis": {
    "bestDirection": "东北",
    "recommendation": "..."
  }
}
```

## 九宫方位

```
┌─────────────────────────────────────┐
│   巽4宫    │   离9宫    │   坤2宫   │
│   东南     │   正南     │   西南    │
├───────────┼───────────┼───────────┤
│   震3宫    │   中5宫    │   兑7宫   │
│   正东     │   中宫     │   正西    │
├───────────┼───────────┼───────────┤
│   艮8宫    │   坎1宫    │   乾6宫   │
│   东北     │   正北     │   西北    │
└─────────────────────────────────────┘
```

## 功能清单

- [x] 阴阳遁自动判断
- [x] 局数计算（1-9局）
- [x] 地盘干分布
- [x] 天盘干转动（转盘排法）
- [x] 九星分布
- [x] 八门分布
- [x] 八神分布
- [x] 暗干计算
- [x] 值符值使确定
- [x] 空亡推算
- [x] 驿马星计算
- [x] 九宫吉凶分析
- [x] 综合分析建议
- [x] 最佳方位推荐
- [x] 实时排盘
- [x] 自定义时间排盘

## 开发指南

### 类型系统

项目包含完整的 TypeScript 类型定义：

```typescript
import type {
  QimenResult,
  QimenOptions,
  JuShuInfo,
  DiPanGan,
  TianPanGan,
  GongAnalysis,
  YinYangDun,
  GongNumber
} from '@/lib/types';
```

### 核心函数

```typescript
import { calculate } from '@/lib/qimen';

// 计算排盘
const result = calculate(new Date(), {
  type: '四柱',
  method: '时家',
  purpose: '综合'
});
```

### 代码风格

- 使用 TypeScript strict 模式
- 遵循 Next.js App Router 最佳实践
- 使用 ES Module 语法
- 函数添加完整的类型注解和 JSDoc

## 参考资料

- 《奇门遁甲统宗》
- 《遁甲符应经》
- 茅山派奇门遁甲传承

## 许可证

ISC License

---

**注意**：本系统仅供学习研究使用，排盘结果仅供参考。
